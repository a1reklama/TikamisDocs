## Функции приложения
В приложении клиент может делать следующие действия:
- Записаться на обслуживание
- Просмотреть свои записи на будущее (далее будут называться **предстоящие записи**)
- Просмотреть историю выполненных заказов (далее будет называться **сервисная история**)
- Оставлять отзывы об обслуживании. Отзыв может быть анонимный, если клиент захочет.

Есть дизайн [на фигме](https://www.figma.com/file/nWi1UCjspbGrjeG9UibgTV/TIKAMIS-IOS%2C-ANDROID?type=design&node-id=510%3A5557&mode=design&t=vlYpxb2gT1RvZThu-1), 
но он сильно отличается от того, какой интерфейс у приложения сейчас, 
т.к. после первой вёрстки по этому дизайну, было много правок заказчиком.  
Сейчас интерфейс приложения тоже немного устарел, о правках я напишу позже.  

## Последовательность записи и выполнения заказа
1. Пользователь в приложении авторизуется/регистрируется
2. Выбирает город, сервисный центр, набор услуг, дату и время
3. Там же пользователь может написать другие номер телефона / номер машины. Эта функция существует, чтобы клиент мог записать своих друзей/родственников через свой аккаунт.
4. После нажатия на кнопку "записаться", этот заказ сохраняется в систему.
5. За час до запланированного обслуживания, клиенту придёт ПУШ уведомление с напоминанием.
6. Когда клиент приедет на автосервис, ему придёт ПУШ с приглашением для заезда на пост. (Ещё будет приглашение на ТАБЛО очереди в автосервисе)
7. После заезда на пост, механик приступает к выполнению заказа. После окончания обслуживания, в приложении появится возможность показать QR код:
8. Механик пошлёт клиента на кассу оплачивать заказ. Клиент показывается QR код в приложении на кассе.
9. На кассе считывается QR код, в котором содержится информация обо всех услугах, номере машины и т.д.
10. После всех этий действий, заказ переносится из списка "предстоящих заказов" в "сервисную историю".

## Краткое описание методов

### Раздел Customer
- POST `mobile-api/customer/ask-sms` - Запросить смс для входа. Подробнее описан [здесь](Авторизация.md)
- POST `mobile-api/customer/login` - Ввести код из смс и тем самым завершить аутентификацию, получив авторизационные токены. Подробнее описан [здесь](Авторизация.md) 
- POST `mobile-api/customer/refresh` - Обновить токены, если от API приходит ошибка **401 Unauthorized**. [здесь](Авторизация.md)
- GET `mobile-api/customer/user_agreement.html` - Страница с пользовательским сообщением.
- GET `mobile-api/customer/qr-code` - получить QR Код (вкладка отдельная). [ссылка](#get-mobile-apicustomerqr-code)
- DELETE `mobile-api/customer/account` - удалить аккаунт и данные пользователя. 

### Раздел CarCenter
- GET `mobile-api/carcenter/get-cities` - Получить список городов. Нужно для выбора на этапе оформления записи. [ссылка](#get-mobile-apicarcenterget-cities)
- GET `mobile-api/carcenter/{city}` - Получить список автосервисов, которые есть в определенном городе. Для этапа оформления записи. [ссылка](#get-mobile-apicarcentercity)
- GET `mobile-api/carcenter/works/{centerId}` - Получить список работ по городу и ID автосервиса. Для этапа оформления записи. [ссылка](#get-mobile-apicarcenterworkscenterid)

### Раздел Cart
- POST `mobile-api/cart/update` - добавить работу в корзину для заказа. [ссылка](#post-mobile-apicart)
- POST `mobile-api/cart/get` - получить корзину клиента. [ссылка](#get-mobile-apicart)
- POST `mobile-api/cart/delete` - удалить услугу из корзины клиента. [ссылка](#delete-mobile-apicartid)

### Раздел Order
- GET `mobile-api/order/available-time/{centerId}` - Получить временные окна для записи на обслуживание. [ссылка](#get-mobile-apiorderavailable-timecenterid)
- POST `mobile-api/order` - создать заказ. [ссылка](#post-mobile-apiorder)
- GET `mobile-api/order` - Получить **предстоящие** заказы. [ссылка](#get-mobile-apiorder)
- POST `mobile-api/order/get-history` - получить **сервисную историю**. [ссылка](#post-mobile-apiorderget-history)
- DELETE `mobile-api/order` - отменить заказ. [ссылка](#delete-mobile-apiorder)

### Раздел Work
- GET `mobile-api/work/all` - получить все услуги. Этот метод нужен для фильтрации на экране *Ремонт* -> *Сервисная история* [ссылка](#get-mobile-apiworkall)

### Раздел Notification
- GET `mobile-api/notification` - получить все уведомления. [ссылка](#get-mobile-apinotification)

### Раздел Review
- POST `mobile-api/review` - отправить отзыв.  [ссылка](#post-mobile-apireview)


## Ответ от сервера 409 Conflict
Если случилась какая-то непредсказуемая проблема, о которой нужно уведомить пользователя, то сообщение
об этой проблеме присылается сервером со статус-кодом **409**.  

Ответ такого типа может прийти от ЛЮБОГО запроса, поэтому в приложении любой ответ от сервера с кодом **409** нужно как-то
обрабатывать и показывать сообщение пользователю в теле ответа.  
В отличие от всех остальных ответов сервера, этот приходит не в виде json, а в виде строки.  
Можно обрабатывать сообщения со статус-кодом 409, например таким образом:
```js
let response = await fetch(URL+'/mobile-api/customer/qr-code');
if (response.status == 409)
  Alert.alert('Внимание', await response.text())
  // Появляется сообщение для пользователя.
```

## Формат запроса к серверу
1. Для большинства запросов сервер ждёт access токен в заголовке `Authorization`. Подробнее об этом [здесь](Авторизация.md)
Запросы, для которых не нужен этот заголовок: `mobile-api/customer/ask-sms`, `mobile-api/customer/login`, `mobile-api/customer/user_agreement.html`. Также, для запроса `mobile-api/customer/refresh` в этом заголовке должен быть *refresh* токен.
2. Также сервер ожидает номер версии API в заголовке `Api-Version`. Сейчас версия "1".
3. Клиент и сервер будут общаться при помощи JSON объектов. Поэтому нужно добавить соответствующие заголовки.
Получается, в большинстве случаев запрос будет иметь следующие заголовки:
```Javascript
{
  'Accept': 'application/json',
  'Api-Version' : 1,
  'Content-Type': 'application/json',
  'Authorization': 'Bearer eyJhbGciOiJI...'
}
```

## Возможные статус-коды ответа от сервера
Общие статус-коды, которые могут прийти от любого запроса. Можно в одном месте их все обрабатывать (например написать обёртку для fetch/axios).  

| Код ответа           | Описание и действия                                                                                                                                                                                                                                                |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 200 OK               | OK                                                                                                                                                                                                                                                                 |
| 401 Unauthorized     | Истёк access токен. Нужно обновить его с помощью refresh. Если такой ответ появляется при обновлении токена (`mobile-api/customer/refresh`), то нужно деавторизовать пользователя.                                                                                                                |
| 409 Conflict         | Произошла какая-то ошибка, сообщение о которой нужно отобразить пользователю. Подробнее в ["Ответ от сервера 409 Conflict"](#ответ-от-сервера-409-conflict). Он может приходить от любого запроса                                                                  |
| 426 Upgrade Required | Пользователю нужно отобразить сообщение: `"Эта версия приложения устарела. Пожалуйста, обновите его в магазине приложений"`. Данные такой запрос не отдаст. Главное, чтобы появилось сообщение.                                                                    |
| 400-499              | **Кроме 401, 409, 426**. Значит ошибка при отправке запроса. Нужно отображать сообщение "Попробуйте перезайти в приложение. Если проблема повторяется, обратитесь в центр поддержки клиентов: 8 800 200-26-67. Убедитесь также, что у вас есть подключение к интернету и что VPN отключен" |
| 500-599              | Ошибка на сервере. Нужно отображать сообщение "Ошибка на сервере. Попробуйте позже или обратитесь в центр поддержки клиентов: 8 800 200-26-67"                                                                                                                                 |


> [!CAUTION]  
> В приложении будут места, где отправляется одновременно несколько запросов. И если в этот момент access токен истечет, и
> оба запроса вызовут метод `mobile-api/customer/refresh`, то один обновит токены, а другой словит ответ 401 от сервера и деавторизует пользователя.  
> Это *race condition* и его можно исправить буквально в две строчки. Например, [по инструкции](https://fuse8.ru/articles/how-to-avoid-race-condition).


## Подробное описание методов


#### GET `mobile-api/customer/qr-code`

Сам QR код вроде находится во вкладке QR код внизу.  
Зачем нужен QR код, я описал [здесь](#последовательность-записи-и-выполнения-заказа).
При вызове метода формат ответа будет следующим:
```json
{
   "result": "eyJJRCI6MjAwMDAwMDEsIkNBUiI6IkFBMDAxQSIsIlJFRyI6IjE4NiIsIk9ET01FVEVSIjoiMTI0NTQiLCJXT1JLUyI6W3si0KbQkS0wMDAwMjg4OSI6Miwi0KbQkS0wMDAwMjkwOSI6MSwi0KbQkS0wMDAwMjkyNyI6MX1dLCJIQVNIIjoiYzUwMWJkNDdiYzk4YTk5MGI0ZjkwMDljOGQ2NjBlNDllZTQ3MDhiYzNjNjE2ZjcxMzdhZGUyZDVkNmMxYzViMCJ9"
}
```
Эти данные нужно просто отрисовать в QR код.
Также, может прийти пустой ответ:
```json
{
  "result": ""
}
```
Это может означать, что сейчас у клиента нет заказов, для которых необходимо отображать QR код. 
В приложении сейчас это не заложено, там, кажется, QR код отображается всегда.

#### GET `mobile-api/carcenter/get-cities`

Метод используется на экране оформления записи.  
Формат ответа:
```json
{
  "cities": [
    {
      "name": "Сургут", "slug": "Сургут"
    },
    {
      "name": "Когалым", "slug": "Когалым"
    }
  ]
}
```
Оба поля `name` и `slug` будут иметь одно и то же значение. Можно использовать любое.  

#### GET `mobile-api/carcenter/{city}`

Метод также используется на этапе записи.  
В запросе нужно указать город, который может быть получен из метода GET `mobile-api/carcenter/get-cities`.  
Ответ будет следующего формата:  
```json
{
  "centers":[
    { "name": "пр-т Гагарина, 15", "record": false, "slug": "ИБ-9848123", "mapLink": "https://<ссылка_на_карту>" },
    { "name": "пр-т Гагарина, 999", "record": true, "slug": "ИБ-8238323", "mapLink": "https://<ссылка_на_карту>" }
  ]
}
```

| Имя поля | Значение                                                                                                                                                                                   |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| name     | Текстовый адрес                                                                                                                                                                            |
| record   | Возможна ли онлайн запись на этом автосервисе. Если невозможна, то должно появляться предупреждение "К сожалению выбранный..."                                                             | 
| slug     | Символьный код автосервиса в базе данных. Он потом нужен будет в последующих запросах.                                                                                                     |
| mapLink  | Ссылка на карту в 2гис. Вроде в приложении переход по ссылке уже должен быть реализован. **Может быть `null`** (если директор ничего не настроил). Тогда пусть просто ничего не происходит |

#### GET `mobile-api/carcenter/works/{centerId}`

Метод используется на этапе записи, чтобы набить корзину услугами.  
Для каждого автосервиса услуги могут иметь разную цену, поэтому и нужно уточнять автосервис.  

Предполагается, что каждая услуга в корзине может быть только в одном экземпляре.  

В запросе нужно передать `centerId`, который можно получить из поля `slug` в запросе GET `mobile-api/carcenter/{city}`.  

Ответ будет выглядеть так:
```json
{
  "items": [
    {
      "id": "БП-45678",
      "sectionId": "1s",
      "name": "Услуга из раздела Двигатель №1",
      "price": 1500,
      "sale": 1000,
      "saleText": "Условия акции*",
      "saleNote": "Примечание к акции*"
    },
    {...}
  ],
  "sections": [
    { "id": "1s", "name": "Двигатель" },
    { "id": "2s", "name": "Трансмиссия" }
  ]
}
```

| Свойство  | Тип             | Описание                                                                                                         |
|-----------|-----------------|------------------------------------------------------------------------------------------------------------------|
| items     | список          | Список услуг:                                                                                                    |
| id        | string          | ID услуги. Понадобится далее, чтобы по ID добавлять её в корзину                                                 |
| sectionId | string          | ID раздела, к которому привязана услуга                                                                          |
| name      | string          | Название услуги                                                                                                  |
| price     | number          | Цена услуги                                                                                                      |
| sale      | number или null | Цена услуги уже со скидкой (может быть null, если скидка отсутствует)                                            |
| saleText  | string          | Описание акции.                                                                                                  |
| saleNote  | string          | Примечание к акции. Это та часть, которая после ТОЧКИ идёт. Если этот пункт непонятен, напиши, объясню подробнее |
| sections  | список          | Список разделов:                                                                                                 |
| id        | string          | ID раздела. Связано с sectionId                                                                                  |
| name      | string          | Название раздела                                                                                                 |

#### POST `mobile-api/cart/update`

Добавление услуги в корзину на сервере.  

Тело запроса должно быть таким:
```json
{
  "workId": "БП-45678",
  "carCenterId": "ИБ-5678"
}
```
*workId* можно получить из запроса [GET mobile-api/carcenter/works/{centerId}](#get-mobile-apicarcenterworkscenterid).  
*carCenterId* уже должен был быть получен из поля `slug` в запросе GET `mobile-api/carcenter/{city}`.

В ответе будет вся корзина клиента.  
Формат ответа будет таким же как в [GET mobile-api/carcenter/works/{centerId}](#get-mobile-apicarcenterworkscenterid)

#### POST `mobile-api/cart/get`

Метод для получения корзины пользователя.  

В запросе нужно указать ID автосервиса:  
```json
{
  "carCenterId": "ИБ-5678"
}
```
*carCenterId* уже должен был быть получен из поля `slug` в запросе GET `mobile-api/carcenter/{city}`.

В ответе будет вся корзина клиента.  
Формат ответа будет таким же как в [GET mobile-api/carcenter/works/{centerId}](#get-mobile-apicarcenterworkscenterid)

#### POST `mobile-api/cart/delete`

Метод для удаления услуги из корзины.  

Тело запроса должно быть таким:
```json
{
  "workId": "БП-45678",
  "carCenterId": "ИБ-5678"
}
```

В ответе будет вся корзина клиента.  
Формат ответа будет таким же как в [GET mobile-api/carcenter/works/{centerId}](#get-mobile-apicarcenterworkscenterid)

#### GET `mobile-api/order/available-time/{centerId}`

Исходя из корзины пользователя, получить свободные для записи окна.  
Здесь я формат ответа немного изменил. В приложении вроде не так реализовано.  
Если какие-то данные удобнее получать по-другому, напиши, можем поменять.  

В строке нужен только айди автосервиса.  
Формат ответа такой:  
```json
{
  "timeList": [
    {
      "date": "2023-04-25",
      "time": "08:30"
    },
    {
      "date": "2023-04-25",
      "time": "09:00"
    },
    {
      "date": "2023-04-26",
      "time": "08:30"
    },
    {
      "date": "2023-04-25",
      "time": "10:30"
    }
  ]
}
```
Время будет приходить отсортированным в хронологическом порядке сразу на несколько дней.  
Здесь не будет промежутков недоступного для записи время. Если нужно добавить, напишешь.  

#### POST `mobile-api/order`

Создать заказ окончательно, когда корзина заполнена и выбрано время.  
Тело запроса:  
```json
{
  "carCenterId": "ИБ-5678",
  "date": "2023-04-26",
  "time": "08:30",
  "phone": "string",
  "gosNumber": "string",
  "region": "string"
}
```
Время и дата должны быть в формате **ГГГГ-ММ-ДД** и **чч:мм**, иначе будет 500 ошибка от сервера приходить. Если нужен другой формат, пиши.  
*phone*, *gosNumber* и *region*: Вроде пользователь может указать другие данные, если, например, хочет оформить заказ на своего родственника.  

От сервера никакого ответа не будет. В случае успешной записи будет только ответ с кодом 200.  

#### GET `mobile-api/order`

Получить заказы для вкладки "Ремонт" -> "Предстоящие записи".  
В запросе ничего не нужно (фильтров кажется в этом экране нет).  
Ответ от сервера будет следующим:  
```json
{
  "records": [
    {
      "id": "20000068",
      "date": "2023-04-26",
      "time": "08:30",
      "city": "Сургут",
      "address": "Сергинская ул., 15а, 1111",
      "services": [
        "11111",
        "2222", 
        "3333"
      ],
      "usedProducts": [],
      "phone": "+7123456789",
      "gosNumber": "АА000А",
      "region": "186",
      "summa": {
        "full": 1650,
        "sale": 1150
      }
      "odometer": ""
    }
  ]
}
```

| Свойство               | Тип    | Описание                                                                                                                                  |
|------------------------|--------|-------------------------------------------------------------------------------------------------------------------------------------------|
| records                | array  | Предстоящие записи                                                                                                                        |
| records[].id           | string | ID записи. Может понадобиться, чтобы потом отменять запись                                                                                |
| records[].date         | string | Дата                                                                                                                                      |
| records[].time         | string | Время                                                                                                                                     |
| records[].city         | string | Город                                                                                                                                     |
| records[].address      | string | Адрес                                                                                                                                     |
| records[].services     | array  | Массив ID выбранных услуг                                                                                                                 |
| records[].usedProducts | array  | Массив товаров, используемых в момент оказания услуг. Используется в сервисной истории (в предстоящих заказах всегда будет пустой список) |
| records[].phone        | string | Номер телефона                                                                                                                            |
| records[].gosNumber    | string | Гос. номер авто                                                                                                                           |
| records[].region       | string | Регион авто                                                                                                                               |
| records[].odometer     | string | Пробег автомобиля. Используется в сервисной истории (в предстоящих заказах всегда будет пустой список).                                   |
| records[].summa        | object | Стоимость услуг                                                                                                                           |
| records[].summa.full   | number | Полная стоимость                                                                                                                          |
| records[].summa.sale   | number | Стоимость со скидкой (в сервисной истории не должно использоваться)                                                                       |

#### POST `mobile-api/order/get-history`

Получить заказы для вкладки "Ремонт" -> "Сервисная история".  
В теле запроса фильтры:  
```json
{
  "visitDateLeft": "2023-04-16",
  "visitDateRight": "2023-04-30",
  "workIds": [
    "11111",
    "2222",
    "3333"
  ]
}
```

| Свойство       | Тип             | Описание                                                                                                                                                          |
|----------------|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| visitDateLeft  | string или null | Левая граница поиска по дате. Если null, то этот фильтр не будет учтен (вернутся все работы)                                                                      |
| visitDateRight | string или null | Правая граница поиска по дате                                                                                                                                     |
| workIds        | string или null | Список ID услуг для фильтрации. Если null, то этот фильтр не будет учтен (вернутся все работы). Этот список может быть получен из метода: GET mobile-api/work/all |

> visitDateLeft и visitDateRight должны быть либо оба равны null либо оба быть string. Иначе API будет выдавать ошибку.                                                                

Тело ответа будет таким же как в [предстоящих заказах](#get-mobile-apiorder)

#### DELETE `mobile-api/order`

Отмена заказа во вкладке "Ремонт" -> "Предстоящие записи".  
Тело запроса содержит только ID заказа:  
```json
{
  "orderId": "20000068"
}
```
Тело ответа будет пустым.  
После этого действия в предстоящих заказах этот заказ должен пропасть.  

#### GET `mobile-api/work/all`

Получить id и имя услуг. Используется в фильтрах в сервисной истории.  
Ответ от сервера в формате:
```json
{
  "works": [
    {
      "id": "ИБ-84293",
      "name": "Шумоизоляция"
    },
    {
      "id": "ИБ-839293",
      "name": "Замена масла"
    }
  ]
}
```

#### GET `mobile-api/notification`

Получить все уведомления пользователя.  
Ответ от сервера в формате:
```json
{
  "notifications": [
    {
      "id": "9832",
      "date": "12.09.2022",
      "title": "Напоминание о записи",
      "text": "Завтра вы записаны на сервисное обслуживание в [время записи] в сервисный центр Тикамис по адресу [адрес СЦ]"
    }
  ]
}
```

| Свойство | Описание                                                  |
|----------|-----------------------------------------------------------|
| id       | id уведомления. Это поле пока не нужно                    |
| date     | Дата в формате 12.09.2022                                 |
| title    | Заголовок уведомления. Вроде в приложении не используется |
| text     | Текст уведомления                                         |


#### POST `mobile-api/review`

Отправка отзыва от пользователя.  
Формат запроса до сервера:  
```json
{
  "smile": "good",
  "textMessage": "string",
  "voice": "string",
  "isAnonymous": true,
  "slug": "string",
  "gosNumber": "string",
  "region": "string"
}
```

| Свойство       | Тип             | Описание                                                                                                                             |
|----------------|-----------------|--------------------------------------------------------------------------------------------------------------------------------------|
| smile          | string или null | Если пользователь выбрал смайл. Возможны 4 состояния: "good", "bad", "average" или null (если пользователь выбрал другой тип отзыва) |
| textMessage    | string или null | Текстовое сообщение (или null, если выбран другой тип)                                                                               |
| voice          | string или null | Голосовое сообщение. Мы вроде договорились, что это будет строка в Base64. Если что-то изменится, поменяю                            |
| isAnonymous    | bool            | Анонимный ли отзыв. (тогда пользователь не передаёт номер автомобиля и регион)                                                       |
| slug           | string          | Айди автосервиса. Запросы для автосервиса те же самые что и для оформления записи (вроде не отличается алгоритм)                     |
| gosNumber      | string или null | Гос.номер который пользователь ввёл в поле для ввода. Если отзыв анонимный, то это поле будет игнорироваться                         |
| region         | string или null | Регион. Если отзыв анонимный, то это поле будет игнорироваться                                                                       |
