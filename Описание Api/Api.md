## Функции приложения
В приложении клиент может делать следующие действия:
- Записаться на обслуживание
- Просмотреть свои записи на будущее (далее будут называться **предстоящие записи**)
- Просмотреть историю выполненных заказов (далее будет называться **сервисная история**)
- Оставлять отзывы об обслуживании. Отзыв может быть анонимный, если клиент захочет.

Есть дизайн [на фигме](https://www.figma.com/file/nWi1UCjspbGrjeG9UibgTV/TIKAMIS-IOS%2C-ANDROID?type=design&node-id=510%3A5557&mode=design&t=vlYpxb2gT1RvZThu-1), 
но он сильно отличается от того, какой интерфейс у приложения сейчас, 
т.к. после первой вёрстки по этому дизайну, было много правок заказчиком.  
Сейчас интерфейс приложения тоже немного устарел, о правках я напишу позже.  

## Последовательность записи и выполнения заказа
1. Пользователь в приложении авторизуется/регистрируется
2. Выбирает город, сервисный центр, набор услуг, дату и время
3. Там же пользователь может написать другие номер телефона / номер машины. Эта функция существует, чтобы клиент мог записать своих друзей/родственников через свой аккаунт.
4. После нажатия на кнопку "записаться", этот заказ сохраняется в систему.
5. За час до запланированного обслуживания, клиенту придёт ПУШ уведомление с напоминанием.
6. Когда клиент приедет на автосервис, ему придёт ПУШ с приглашением для заезда на пост. (Ещё будет приглашение на ТАБЛО очереди в автосервисе)
7. После заезда на пост, механик приступает к выполнению заказа. После окончания обслуживания, в приложении появится возможность показать QR код:
8. Механик пошлёт клиента на кассу оплачивать заказ. Клиент показывается QR код в приложении на кассе.
9. На кассе считывается QR код, в котором содержится информация обо всех услугах, номере машины и т.д.
10. После всех этий действий, заказ переносится из списка "предстоящих заказов" в "сервисную историю".

## Краткое описание методов

### Раздел Customer
- POST `mobile-api/customer/ask-sms` - Запросить смс для входа. Подробнее описан [здесь](Авторизация.md)
- POST `mobile-api/customer/login` - Ввести код из смс и тем самым завершить аутентификацию, получив авторизационные токены. Подробнее описан [здесь](Авторизация.md) 
- POST `mobile-api/customer/refresh` - Обновить токены, если от API приходит ошибка **401 Unauthorized**. [здесь](Авторизация.md)
- GET `mobile-api/customer/user_agreement.html` - Страница с пользовательским сообщением.
- GET `mobile-api/customer/qr-code` - получить QR Код (вкладка отдельная). [ссылка](#get-mobile-apicustomerqr-code)
- DELETE `mobile-api/customer/account` - удалить аккаунт и данные пользователя. 

### Раздел CarCenter
- GET `mobile-api/carcenter/get-cities` - Получить список городов. Нужно для выбора на этапе записи. [ссылка](#get-mobile-apicarcenterget-cities)
- GET `mobile-api/carcenter/{city}` - Получить список автосервисов, которые есть в определенном городе. Для этапа заказа. [ссылка](#get-mobile-apicarcentercity)
- GET `mobile-api/carcenter/{centerId}` - Получить список работ по городу и ID автосервиса. Для этапа заказа.

### Раздел Cart
- POST `mobile-api/cart` - добавить работу в корзину для заказа.
- GET `mobile-api/cart` - получить корзину клиента.
- DELETE `mobile-api/cart/{id}` - удалить услугу из корзины клиента.

### Раздел Order
- GET `mobile-api/order/available-time/{centerId}` - Получить временные окна для записи на обслуживание.
- POST `mobile-api/order` - создать заказ. 
- GET `mobile-api/order` - Получить **предстоящие** заказы.
- POST `mobile-api/order/get-history` - получить **сервисную историю**.
- DELETE `mobile-api/order` - отменить заказ.

### Раздел Work
- GET `mobile-api/work/all` - получить все услуги. Этот метод нужен для фильтрации на экране *Ремонт* -> *Сервисная история*
- GET `mobile-api/work/sale-info/{workId}` - получить информацию о 

### Раздел Notification
- GET `mobile-api/notification` - получить все уведомления.

### Раздел Review
- POST `mobile-api/review` - отправить отзыв.


## Ответ от сервера 409 Conflict
Если случилась какая-то непредсказуемая проблема, о которой нужно уведомить пользователя, то сообщение
об этой проблеме присылается сервером со статус кодом **409**.  

Ответ такого типа может прийти от ЛЮБОГО запроса, поэтому в приложении любой ответ от сервера с кодом **409** нужно как-то
обрабатывать и показывать сообщение пользователю в теле ответа.  
В отличие от всех остальных ответов сервера, этот приходит не в виде json, а в виде строки.  
Можно обрабатывать сообщения со статус-кодом 409, например таким образом:
```js
let response = await fetch(URL+'/mobile-api/customer/qr-code');
if (response.status == 409)
   alert(await response.text());
// Появляется сообщение для пользователя. 
// В react native код будет другой, не помню, как там такое окно показать. 
```

## Формат запроса к серверу
1. Для большинства запросов сервер ждёт access токен в заголовке `Authorization`. Подробнее об этом [здесь](Авторизация.md)
2. Также сервер ожидает номер версии API в заголовке `Api-Version`. Сейчас версия "1".
3. Клиент и сервер будут общаться при помощи JSON объектов. Поэтому нужно добавить соответствующие заголовки.
Получается, в большинстве случаев запрос будет иметь следующие заголовки:
```Javascript
{
  'Accept': 'application/json',
  'Api-Version' : 1,
  'Content-Type': 'application/json',
  'Authorization': 'Bearer eyJhbGciOiJI...'
}
```

## Возможные статус-коды ответа от сервера
Общие статус-коды, которые могут прийти от любого запроса. Можно в одном месте их все обрабатывать (например написать обёртку для fetch/axios).  

| Код ответа           | Описание и действия                                                                                                                                                                                                                                                |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 200 OK               | OK                                                                                                                                                                                                                                                                 |
| 401 Unauthorized     | Истёк access токен. Нужно обновить его с помощью refresh. Если такой ответ появляется при обновлении токена, то нужно деавторизовать пользователя.                                                                                                                 |
| 409 Conflict         | Произошла какая-то ошибка, сообщение о которой нужно отобразить пользователю. Подробнее в ["Ответ от сервера 409 Conflict"](#ответ-от-сервера-409-conflict). Он может приходить от любого запроса                                                                  |
| 426 Upgrade Required | Пользователю нужно отобразить сообщение: `"Эта версия приложения устарела. Пожалуйста, обновите его в магазине приложений"`. Данные такой запрос не отдаст. Главное, чтобы появилось сообщение.                                                                    |
| 400-499              | **Кроме 401, 409, 426**. Значит ошибка при отправке запроса. Нужно отображать сообщение "Попробуйте перезайти в приложение. Если проблема повторяется, напишите нам на ${SupportMail}. Убедитесь также, что у вас есть подключение к интернету и что VPN отключен" |
| 500-599              | Ошибка на сервере. Нужно отображать сообщение "Ошибка на сервере. Попробуйте позже или обратитесь в тех.поддержку: ${SupportMail}"                                                                                                                                 |


> [!CAUTION]  
> В приложении будут места, где отправляется одновременно несколько запросов. И если в этот момент access токен истечет, и
> оба запроса вызовут метод `mobile-api/customer/refresh`, то один обновит токены, а другой словит ответ 401 от сервера и деавторизует пользователя.  
> Это *race condition* и его можно исправить буквально в две строчки. Например, [по инструкции](https://fuse8.ru/articles/how-to-avoid-race-condition).


## Подробное описание методов


#### GET `mobile-api/customer/qr-code`

Сам QR код вроде находится во вкладке QR код внизу.  
Зачем нужен QR код, я описал [здесь](#последовательность-записи-и-выполнения-заказа).
При вызове метода формат ответа будет следующим:
```json
{
   "result": "eyJJRCI6MjAwMDAwMDEsIkNBUiI6IkFBMDAxQSIsIlJFRyI6IjE4NiIsIk9ET01FVEVSIjoiMTI0NTQiLCJXT1JLUyI6W3si0KbQkS0wMDAwMjg4OSI6Miwi0KbQkS0wMDAwMjkwOSI6MSwi0KbQkS0wMDAwMjkyNyI6MX1dLCJIQVNIIjoiYzUwMWJkNDdiYzk4YTk5MGI0ZjkwMDljOGQ2NjBlNDllZTQ3MDhiYzNjNjE2ZjcxMzdhZGUyZDVkNmMxYzViMCJ9"
}
```
Эти данные нужно просто отрисовать в QR код.
Также, может прийти пустой ответ:
```json
{
  "result": ""
}
```
Это может означать, что сейчас у клиента нет заказов, для которых необходимо отображать QR код. 
В приложении сейчас это не заложено, там, кажется, QR код отображается всегда.

#### GET `mobile-api/carcenter/get-cities`

Метод используется на экране оформления записи.  
Формат ответа:
```json
{
  "cities": [
    {
      "name": "Сургут", "slug": "Сургут"
    },
    {
      "name": "Когалым", "slug": "Когалым"
    }
  ]
}
```
Оба поля `name` и `slug` будут иметь одно и то же значение. Можно использовать любое.  

#### GET `mobile-api/carcenter/{city}`

Метод также используется на этапе записи.  
В запросе нужно указать город, который может быть получен из метода GET `mobile-api/carcenter/get-cities`.  
Ответ будет следующего формата:  
```json
{
  "centers":[
    { "name": "пр-т Гагарина, 15", "record": false, "slug": "ИБ-9848123", "mapLink": "https://<ссылка_на_карту>" },
    { "name": "пр-т Гагарина, 999", "record": true, "slug": "ИБ-8238323", "mapLink": "https://<ссылка_на_карту>" }
  ]
}
```

| Имя поля | Значение                                                                                                                                                                                   |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| name     | Текстовый адрес                                                                                                                                                                            |
| record   | Возможна ли онлайн запись на этом автосервисе. Если невозможна, то должно появляться предупреждение "К сожалению выбранный..."                                                             | 
| slug     | Символьный код автосервиса в базе данных. Он потом нужен будет в последующих запросах.                                                                                                     |
| mapLink  | Ссылка на карту в 2гис. Вроде в приложении переход по ссылке уже должен быть реализован. **Может быть `null`** (если директор ничего не настроил). Тогда пусть просто ничего не происходит |

#### GET `mobile-api/carcenter/{centerId}`

Метод используется на этапе записи, чтобы набить корзину услугами.  
Для каждого автосервиса услуги могут иметь разную цену, поэтому и нужно уточнять автосервис.  

Вообще, предполагается, что каждая услуга в корзине может быть только в одном экземпляре. 
Вроде, в приложении иначе и нельзя.  

В запросе нужно передать `centerId`, который можно получить из поля `slug` в запросе GET `mobile-api/carcenter/{city}`.  

**Сейчас изменяется формат этого запроса, позже добавлю его описание**
